define(["jquery","core/notification","core/templates","core/custom_interaction_events","mod_communication/communication_templates_repository"],function(a,b,c,d,e){var f={EMPTY_MESSAGE:'[data-region="empty-message"]',ROOT:'[data-region="template-list-container"]',TEMPLATE_LIST:'[data-region="template-list"]',TEMPLATE_LIST_CONTENT:'[data-region="template-list-content"]',TEMPLATE_LIST_GROUP_CONTAINER:'[data-region="template-list-group-container"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',VIEW_MORE_BUTTON:'[data-action="view-more"]'},g=function(a){a.attr("data-loaded-all",!0)},h=function(a){return!!a.attr("data-loaded-all")},i=function(a){var b=a.find(f.LOADING_ICON_CONTAINER),c=a.find(f.VIEW_MORE_BUTTON);a.addClass("loading"),b.removeClass("hidden"),c.prop("disabled",!0)},j=function(a){var b=a.find(f.LOADING_ICON_CONTAINER),c=a.find(f.VIEW_MORE_BUTTON);a.removeClass("loading"),b.addClass("hidden"),h(a)||c.prop("disabled",!1)},k=function(a){return a.hasClass("loading")},l=function(a){a.attr("data-has-templates",!0)},m=function(a){return!!a.attr("data-has-templates")},n=function(a,b){b?l(a):m(a)||o(a)},o=function(a){a.find(f.TEMPLATE_LIST_CONTENT).addClass("hidden"),a.find(f.EMPTY_MESSAGE).removeClass("hidden")},p=function(a,b,d){return a.removeClass("hidden"),c.render(d,{templates:b}).done(function(b,d){c.appendNodeContents(a.find(f.TEMPLATE_LIST),b,d)})},q=function(b,c){var d=0;return a.when.apply(a,a.map(b.find(f.TEMPLATE_LIST_GROUP_CONTAINER),function(b){var e=c;return e.length?(d+=e.length,p(a(b),e,"mod_communication/template-list-items")):null})).then(function(){return d})},r=function(c,d){c=a(c);var f=+c.attr("data-limit"),h=c.attr("data-last-id"),l=a("#id_messagetypefilter").val();if(k(c))return a.Deferred().resolve();if(i(c),"undefined"==typeof d){var m={from:0,limit:f};l?m.messagetype=l:m.messagetype=0,h&&(m.from=h),d=e.query(m)}return d.then(function(a){return a}).then(function(a){return(!a.length||a.length<f)&&g(c),a.length?(c.attr("data-last-id",a[a.length-1].id),q(c,a).then(function(b){n(c,a.length),b<a.length&&g(c)})):void n(c,a.length)}).fail(b.exception).always(function(){j(c)})},s=function(a){d.define(a,[d.events.activate]),a.on(d.events.activate,f.VIEW_MORE_BUTTON,function(){r(a)})};return{init:function(b){b=a(b),r(b),s(b)},registerEventListeners:s,load:r,rootSelector:f.ROOT}});